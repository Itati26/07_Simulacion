<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>07_Division_DataSet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Base: Dark Mode (Tema Oscuro) üåô */
        body {
            background-color: #1e293b; /* Gris oscuro azulado */
            padding: 20px;
            color: #e2e8f0; /* Gris claro para texto general */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        h1 {
            font-size: 30px;
            font-weight: 700;
            margin-bottom: 30px;
            color: #67e8f9; /* Cian claro llamativo */
            letter-spacing: 1.5px;
        }

        h6 {
            color: #94a3b8; /* Gris azulado para subt√≠tulos */
            font-weight: 600;
            margin-top: 15px; 
        }

        .panda {
            font-size: 32px;
            display: inline-block;
            margin-right: 12px;
            vertical-align: middle;
            color: #67e8f9; 
        }

        /* Cards / sections */
        .table-wrapper, .plot-wrapper, .upload-form {
            background: #334155; 
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #475569; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); 
            transition: transform .2s ease, box-shadow .2s ease;
            margin-top: 20px; 
        }

        .upload-form {
            margin-bottom: 30px; 
        }

        /* Table card header/body */
        .data-card-header {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #1e293b; 
            border-bottom: 1px solid #475569;
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
            margin: -20px -20px 20px -20px; 
        }

        .data-card-title {
            color: #f1f5f9; 
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        /* Table üìä -- ESTILOS CR√çTICOS REPARADOS PARA PANDAS/DATOS -- */
        .data-table-container {
            overflow-x: auto;
            border-radius: 8px; 
            max-height: 60vh; 
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1); 
        }
        
        /* Aseguramos que la tabla generada por Python sea visible */
        .data-table-container table,
        .data-table-container .dataframe {
            border-collapse: collapse !important;
            width: 100% !important;
            margin: 0 !important;
            color: #e2e8f0; /* Color del texto visible */
            font-size: 13px !important;
            min-width: 800px;
            background: #334155; /* Fondo de la tabla visible */
        }

        .data-table-container th {
            background: #1e293b !important; 
            border-bottom: 2px solid #67e8f9 !important; 
            font-weight: 700 !important;
            color: #67e8f9 !important; /* Color de encabezado visible */
            padding: 12px 14px !important;
            text-align: left !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 10 !important;
        }

        .data-table-container td {
            border-bottom: 1px solid #475569 !important;
            color: #f1f5f9 !important; /* Color de dato visible */
            padding: 10px 14px !important;
            vertical-align: middle !important;
        }

        .data-table-container tbody tr:nth-child(odd) {
            background: #334155 !important;
        }

        .data-table-container tbody tr:nth-child(even) {
            background: #3f516a !important;
        }

        /* Sync bar (Mantenido funcional) */
        .scroll-sync {
            overflow-x: auto;
            overflow-y: hidden;
            height: 12px;
            position: sticky;
            top: 10px; 
            z-index: 999;
            background: transparent;
            margin-bottom: 10px;
        }

        .scroll-sync .sync-bar {
            height: 4px;
            background: #67e8f9; 
            border-radius: 4px;
        }

        /* Formulario üìù */
        .upload-form .form-label, .upload-form .form-text, .upload-form label {
            color: #f1f5f9;
        }

        .upload-form .form-control {
            background: #1e293b;
            border: 1px solid #475569;
            color: #e2e8f0;
            box-shadow: none;
        }
        
        /* Botones ‚ú® */
        .btn-primary {
            background-color: #67e8f9;
            border-color: #67e8f9;
            color: #1e293b !important; 
            font-weight: 700;
            transition: all .2s ease;
        }

        .btn-primary:hover, .btn-primary:focus {
            background-color: #38bdf8;
            border-color: #38bdf8;
            color: #1e293b !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(103, 232, 249, 0.4);
        }

        /* Plots (Gr√°ficos) üìà */
        .plot-container-wrapper {
            margin-top: 30px; 
            margin-bottom: 20px; 
        }

        .plot-wrapper {
            padding: 12px; 
            background: #334155;
            border-radius: 16px;
            border: 1px solid #475569;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .plot-wrapper h6 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #67e8f9;
        }

        .plot-img {
            width: 100%;
            border-radius: 8px; 
            max-height: 180px; 
            object-fit: contain; 
            cursor: zoom-in;
        }
        
        .col-plot-4 {
            width: 25%;
            padding: 0 8px;
            min-width: 200px; /* Aseguramos que no se achiquen demasiado en pantallas peque√±as */
        }

        /* Alertas (Para errores) */
        .alert-danger {
            background-color: #ef4444; 
            border-color: #dc2626;
            color: #ffffff;
            font-weight: 600;
            border-radius: 8px;
            padding: 12px 20px;
            margin-top: 20px;
        }

        /* Lightbox (Galer√≠a de im√°genes) üñºÔ∏è - Mantenido */
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1050;
            opacity: 0;
            transition: opacity .35s ease;
        }
        .lightbox-overlay.active { display: flex; opacity: 1; }
        .lightbox-content { max-width: 96vw; max-height: 94vh; text-align: center; }
        .lightbox-content img {
            max-width: 100%;
            max-height: 88vh;
            border-radius: 14px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.8);
        }
        .lightbox-caption { display:none; }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 25px;
            color: #67e8f9;
            font-size: 34px;
            cursor: pointer;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        }
        .lightbox-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #67e8f9;
            font-size: 40px;
            cursor: pointer;
            padding: 15px 20px;
            user-select: none;
        }

        @keyframes fadeIn {
             from { opacity: 0; }
             to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center"><span class="panda" role="img" aria-label="panda"></span>PandasArff</h1>
        
        <div class="upload-form">
            <form method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                <div class="mb-3">
                    <label class="form-label">Selecciona fuente</label>
                    <div>
                        {% for radio in form.source %}
                            <div class="form-check form-check-inline">
                                {{ radio.tag }}
                                <label class="form-check-label ms-1 me-3" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div id="upload-block" class="mb-3 row align-items-center">
                    <div class="col-md-12">
                        <label class="form-label">Subir archivo (.arff)</label>
                        {{ form.arff_file }}
                    </div>
                </div>

                <div id="github-block" class="mb-3" style="display:none;">
                    <label class="form-label">URL del archivo en GitHub</label>
                    {{ form.github_url }}
                </div>

                <div class="d-flex justify-content-end mt-2">
                    <button type="submit" class="btn btn-primary">Visualizar</button>
                </div>
            </form>
        </div>

        {% if error %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
        {% endif %}

        {% if df_html %}
            
            <div class="row g-3 plot-container-wrapper">
                {% if protocol_col %}
                <div class="col-12">
                    <h6>Distribuci√≥n de {{ protocol_col }} (4 vistas)</h6>
                </div>
                <div class="d-flex flex-row flex-wrap justify-content-start">
                    {% if plots.prot_full %}
                    <div class="col-plot-4">
                        <div class="plot-wrapper">
                            <h6>Dataset completo</h6>
                            <img class="plot-img" src="data:image/png;base64,{{ plots.prot_full }}" alt="protocol_type dataset" />
                        </div>
                    </div>
                    {% endif %}
                    {% if plots.prot_train %}
                    <div class="col-plot-4">
                        <div class="plot-wrapper">
                            <h6>Train</h6>
                            <img class="plot-img" src="data:image/png;base64,{{ plots.prot_train }}" alt="protocol_type train" />
                        </div>
                    </div>
                    {% endif %}
                    {% if plots.prot_val %}
                    <div class="col-plot-4">
                        <div class="plot-wrapper">
                            <h6>Validaci√≥n</h6>
                            <img class="plot-img" src="data:image/png;base64,{{ plots.prot_val }}" alt="protocol_type val" />
                        </div>
                    </div>
                    {% endif %}
                    {% if plots.prot_test %}
                    <div class="col-plot-4">
                        <div class="plot-wrapper">
                            <h6>Test</h6>
                            <img class="plot-img" src="data:image/png;base64,{{ plots.prot_test }}" alt="protocol_type test" />
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <div class="table-wrapper">
                <div class="data-card-header">
                    <span class="panda" role="img" aria-label="panda" style="font-size:22px;">üêº</span>
                    <div>
                        <p class="data-card-title">Contenido: {{ file_name }}</p>
                        <small style="color:#94a3b8;">{{ num_rows }} filas √ó {{ num_cols }} columnas</small>
                    </div>
                </div>

                <div class="data-card-body">
                    <div class="data-table-container">
                        {{ df_html|safe }}
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-3">
                {% if plots.split_sizes %}
                <div class="col-md-6">
                    <div class="plot-wrapper">
                        <h6>Tama√±os de Divisi√≥n</h6>
                         <img class="plot-img" src="data:image/png;base64,{{ plots.split_sizes }}" alt="Division sizes plot" style="max-height: 200px;" />
                    </div>
                </div>
                {% endif %}
                </div>
        {% endif %}
    </div>
    <div id="lightbox" class="lightbox-overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="lightbox-close" aria-label="Cerrar" title="Cerrar">√ó</div>
        <div class="lightbox-arrow lightbox-prev" aria-label="Anterior" title="Anterior">‚Äπ</div>
        <div class="lightbox-arrow lightbox-next" aria-label="Siguiente" title="Siguiente">‚Ä∫</div>
        <div class="lightbox-content">
            <img id="lightbox-img" alt="" />
            <div id="lightbox-cap" class="lightbox-caption"></div>
        </div>
    </div>

    <script>
        function toggleSource() {
            const uploadBlock = document.getElementById('upload-block');
            const githubBlock = document.getElementById('github-block');
            const radios = document.querySelectorAll('input[name="source"]');
            let val = 'upload';
            radios.forEach(r => { if (r.checked) val = r.value; });
            if (val === 'upload') {
                uploadBlock.style.display = '';
                githubBlock.style.display = 'none';
            } else {
                uploadBlock.style.display = 'none';
                githubBlock.style.display = '';
            }
        }
        document.addEventListener('DOMContentLoaded', function(){
            const radios = document.querySelectorAll('input[name="source"]')
            radios.forEach(r => r.addEventListener('change', toggleSource));
            toggleSource();

            const tableContainer = document.querySelector('.data-table-container');
            const topSync = document.createElement('div');
            topSync.className = 'scroll-sync';

            if (tableContainer) {
                const parent = tableContainer.parentNode;
                parent.insertBefore(topSync, tableContainer);

                const updateSync = () => {
                    // Ahora buscamos la tabla dentro del contenedor
                    const table = tableContainer.querySelector('table, .dataframe'); 
                    topSync.innerHTML = '';
                    if (table) {
                        const inner = document.createElement('div');
                        inner.className = 'sync-bar';
                        inner.style.width = table.scrollWidth + 'px';
                        topSync.appendChild(inner);
                    }
                };

                topSync.addEventListener('scroll', () => { tableContainer.scrollLeft = topSync.scrollLeft; });
                tableContainer.addEventListener('scroll', () => { topSync.scrollLeft = tableContainer.scrollLeft; });
                window.addEventListener('resize', updateSync);
                // Peque√±o delay para asegurar que el contenido din√°mico de Pandas haya cargado
                setTimeout(updateSync, 100); 
            }

            // Lightbox gallery for plots (Mantenido funcionalmente)
            const imgs = Array.from(document.querySelectorAll('.plot-img'));
            const overlay = document.getElementById('lightbox');
            const imgEl = document.getElementById('lightbox-img');
            const capEl = document.getElementById('lightbox-cap');
            const btnClose = overlay.querySelector('.lightbox-close');
            const btnPrev = overlay.querySelector('.lightbox-prev');
            const btnNext = overlay.querySelector('.lightbox-next');
            let current = -1;

            function openLightbox(index){
                if(index < 0 || index >= imgs.length) return;
                current = index;
                const src = imgs[current].getAttribute('src');
                const alt = imgs[current].getAttribute('alt') || '';
                const thumb = imgs[current];
                const rect = thumb.getBoundingClientRect();
                const clone = thumb.cloneNode(true);
                clone.style.position = 'fixed';
                clone.style.left = rect.left + 'px';
                clone.style.top = rect.top + 'px';
                clone.style.width = rect.width + 'px';
                clone.style.height = rect.height + 'px';
                clone.style.margin = 0;
                clone.style.zIndex = 1100;
                clone.style.transition = 'all .35s cubic-bezier(0.16, 0.68, 0.43, 0.99)';
                clone.style.borderRadius = '12px'; 
                document.body.appendChild(clone);

                const tempImg = new Image();
                tempImg.onload = () => {
                    const padding = 0.08; 
                    const maxW = window.innerWidth * (1 - padding);
                    const maxH = window.innerHeight * (1 - padding);
                    const ratio = tempImg.naturalWidth / tempImg.naturalHeight || 1;
                    let targetW = maxW;
                    let targetH = targetW / ratio;
                    if (targetH > maxH) { targetH = maxH; targetW = targetH * ratio; }
                    const targetLeft = (window.innerWidth - targetW)/2;
                    const targetTop = (window.innerHeight - targetH)/2;

                    overlay.classList.add('active');
                    overlay.setAttribute('aria-hidden', 'false');
                    imgEl.style.opacity = '0';
                    imgEl.style.transition = 'none';
                    imgEl.style.width = targetW + 'px';
                    imgEl.style.height = targetH + 'px';
                    const lbContent = overlay.querySelector('.lightbox-content');
                    if (lbContent) {
                        lbContent.style.position = 'fixed';
                        lbContent.style.left = targetLeft + 'px';
                        lbContent.style.top = targetTop + 'px';
                        lbContent.style.width = targetW + 'px';
                        lbContent.style.height = targetH + 'px';
                    }
                    imgEl.setAttribute('src', src);
                    imgEl.setAttribute('alt', alt);

                    requestAnimationFrame(()=>{
                        clone.style.left = targetLeft + 'px';
                        clone.style.top = targetTop + 'px';
                        clone.style.width = targetW + 'px';
                        clone.style.height = targetH + 'px';
                        clone.style.boxShadow = '0 20px 50px rgba(0,0,0,0.55)';
                    });

                    clone.addEventListener('transitionend', ()=>{
                        clone.remove();
                        requestAnimationFrame(()=>{ imgEl.style.opacity = '1'; });
                    }, { once:true });
                };
                tempImg.src = src;
            }
            function closeLightbox(){
                overlay.classList.remove('active');
                overlay.setAttribute('aria-hidden', 'true');
                imgEl.style.width = '';
                imgEl.style.height = '';
                const lbContent = overlay.querySelector('.lightbox-content');
                if (lbContent) {
                    lbContent.style.position = '';
                    lbContent.style.left = '';
                    lbContent.style.top = '';
                    lbContent.style.width = '';
                    lbContent.style.height = '';
                }
                current = -1;
            }
            function next(){ if(current !== -1) openLightbox((current + 1) % imgs.length); }
            function prev(){ if(current !== -1) openLightbox((current - 1 + imgs.length) % imgs.length); }

            imgs.forEach((img, i) => {
                img.style.cursor = 'zoom-in';
                img.addEventListener('click', () => openLightbox(i));
                img.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); openLightbox(i); }});
                img.setAttribute('tabindex', '0');
            });
            btnClose.addEventListener('click', closeLightbox);
            overlay.addEventListener('click', (e) => { if(e.target === overlay) closeLightbox(); });
            btnNext.addEventListener('click', next);
            btnPrev.addEventListener('click', prev);
            document.addEventListener('keydown', (e) => {
                if(!overlay.classList.contains('active')) return;
                if(e.key === 'Escape') closeLightbox();
                if(e.key === 'ArrowRight') next();
                if(e.key === 'ArrowLeft') prev();
            });
        });
    </script>
</body>
</html>
